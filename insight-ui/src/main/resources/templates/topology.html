<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spring Insight - 拓扑图</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">

    <!-- ECharts -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>

    <style>
        body {
            background-color: #f8f9fc;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding-top: 70px;
        }

        .navbar {
            box-shadow: 0 2px 4px rgba(0,0,0,.1);
        }

        .chart-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.1);
            margin-bottom: 20px;
            height: 600px;
        }

        .control-panel {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.1);
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
<!-- 导航栏 -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
    <div class="container-fluid">
        <a class="navbar-brand" href="/insight-ui">
            <i class="fas fa-chart-network me-2"></i>Spring Insight
        </a>

        <div class="collapse navbar-collapse">
            <ul class="navbar-nav me-auto">
                <li class="nav-item">
                    <a class="nav-link" href="/insight-ui">
                        <i class="fas fa-tachometer-alt me-1"></i>仪表盘
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="/insight-ui/topology">
                        <i class="fas fa-project-diagram me-1"></i>拓扑图
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/insight-ui/traces">
                        <i class="fas fa-stream me-1"></i>链路追踪
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/insight-ui/error-analysis">
                        <i class="fas fa-exclamation-triangle me-1"></i>错误分析
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/insight-ui/about">
                        <i class="fas fa-info-circle me-1"></i>关于
                    </a>
                </li>
            </ul>
        </div>
    </div>
</nav>

<!-- 主内容区域 -->
<div class="container-fluid mt-4">
    <!-- 页面标题 -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1"><i class="fas fa-project-diagram me-2 text-primary"></i>服务拓扑图</h2>
            <p class="text-muted mb-0">可视化展示微服务之间的调用关系</p>
        </div>
    </div>

    <!-- 控制面板 -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="control-panel">
                <h5><i class="fas fa-sliders-h me-2"></i>控制面板</h5>

                <div class="mb-3">
                    <label class="form-label">时间范围</label>
                    <select class="form-select" id="time-range">
                        <option value="1">近1小时</option>
                        <option value="6">近6小时</option>
                        <option value="24" selected>近24小时</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label class="form-label">节点大小</label>
                    <select class="form-select" id="node-size">
                        <option value="traffic">按流量</option>
                        <option value="error">按错误率</option>
                        <option value="fixed">固定大小</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label class="form-label">布局类型</label>
                    <select class="form-select" id="layout-type">
                        <option value="force">力引导布局</option>
                        <option value="circular">环形布局</option>
                    </select>
                </div>

                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="show-labels" checked>
                    <label class="form-check-label" for="show-labels">显示标签</label>
                </div>

                <button class="btn btn-primary w-100" onclick="refreshTopology()">
                    <i class="fas fa-sync-alt me-1"></i>刷新图表
                </button>
            </div>
        </div>

        <div class="col-md-9">
            <div class="chart-container">
                <div id="topology-chart"></div>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
    let topologyChart = null;

    function initTopologyChart() {
        topologyChart = echarts.init(document.getElementById('topology-chart'));
        updateTopologyData();

        // 监听窗口大小变化
        window.addEventListener('resize', function() {
            if (topologyChart) {
                topologyChart.resize();
            }
        });
    }

    function updateTopologyData() {
        if (!topologyChart) return;

        // 模拟数据
        const services = ['user-service', 'order-service', 'product-service', 'payment-service', 'inventory-service'];

        // 生成节点
        const nodes = services.map(service => ({
            name: service,
            symbolSize: 40 + Math.random() * 30,
            itemStyle: {
                color: getServiceColor(service)
            },
            label: {
                show: document.getElementById('show-labels').checked
            }
        }));

        // 生成边（调用关系）
        const links = [];
        for (let i = 0; i < services.length; i++) {
            for (let j = 0; j < services.length; j++) {
                if (i !== j && Math.random() > 0.5) {
                    links.push({
                        source: services[i],
                        target: services[j],
                        value: Math.floor(Math.random() * 100) + 10,
                        lineStyle: {
                            width: Math.min(5, Math.random() * 3 + 1)
                        }
                    });
                }
            }
        }

        const layoutType = document.getElementById('layout-type').value;

        const option = {
            tooltip: {
                formatter: function(params) {
                    if (params.dataType === 'node') {
                        return params.name;
                    } else {
                        return params.data.source + ' → ' + params.data.target + '<br/>调用次数: ' + params.data.value;
                    }
                }
            },
            animationDuration: 1500,
            animationEasingUpdate: 'quinticInOut',
            series: [{
                type: 'graph',
                layout: layoutType,
                data: nodes,
                links: links,
                roam: true,
                label: {
                    position: 'right',
                    formatter: '{b}'
                },
                lineStyle: {
                    color: 'source',
                    curveness: 0.3
                },
                emphasis: {
                    focus: 'adjacency',
                    lineStyle: {
                        width: 10
                    }
                }
            }]
        };

        topologyChart.setOption(option);
    }

    function getServiceColor(serviceName) {
        const colors = ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b', '#6f42c1'];
        let hash = 0;
        for (let i = 0; i < serviceName.length; i++) {
            hash = serviceName.charCodeAt(i) + ((hash << 5) - hash);
        }
        return colors[Math.abs(hash) % colors.length];
    }

    function refreshTopology() {
        updateTopologyData();
    }

    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', function() {
        initTopologyChart();

        // 绑定事件监听
        document.getElementById('time-range').addEventListener('change', updateTopologyData);
        document.getElementById('node-size').addEventListener('change', updateTopologyData);
        document.getElementById('layout-type').addEventListener('change', updateTopologyData);
        document.getElementById('show-labels').addEventListener('change', updateTopologyData);
    });
</script>
</body>
</html>