<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.w3.org/1999/xhtml"
      layout:decorate="~{layout/base}"
      th:with="title='Spring Insight - 拓扑图'">
<head>
    <title>Spring Insight - 拓扑图</title>
    <style>
        #topology-container {
            height: 600px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.1);
        }

        .topology-controls {
            position: absolute;
            top: 100px;
            right: 30px;
            z-index: 100;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .node-detail {
            position: absolute;
            top: 100px;
            left: 30px;
            z-index: 100;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-width: 300px;
            display: none;
        }
    </style>
</head>
<body>

<div layout:fragment="content">
    <!-- 页面标题 -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1"><i class="fas fa-project-diagram me-2 text-primary"></i>服务拓扑图</h2>
            <p class="text-muted mb-0">可视化展示微服务之间的调用关系</p>
        </div>

        <div class="btn-group">
            <button type="button" class="btn btn-outline-primary" onclick="exportTopology()">
                <i class="fas fa-download me-1"></i>导出图片
            </button>
            <button type="button" class="btn btn-outline-success" onclick="autoLayout()">
                <i class="fas fa-magic me-1"></i>自动布局
            </button>
        </div>
    </div>

    <!-- 控制面板 -->
    <div class="topology-controls">
        <h6><i class="fas fa-sliders-h me-2"></i>控制面板</h6>

        <div class="mb-3">
            <label class="form-label small mb-2">时间范围</label>
            <select class="form-select form-select-sm" id="time-range" onchange="loadTopologyData()">
                <option value="1">近1小时</option>
                <option value="6">近6小时</option>
                <option value="24" selected>近24小时</option>
                <option value="168">近7天</option>
            </select>
        </div>

        <div class="mb-3">
            <label class="form-label small mb-2">节点大小</label>
            <select class="form-select form-select-sm" id="node-size" onchange="updateNodeSize()">
                <option value="traffic">按流量</option>
                <option value="error">按错误率</option>
                <option value="fixed">固定大小</option>
            </select>
        </div>

        <div class="mb-3">
            <label class="form-label small mb-2">布局类型</label>
            <select class="form-select form-select-sm" id="layout-type" onchange="changeLayout()">
                <option value="force">力引导布局</option>
                <option value="circular">环形布局</option>
                <option value="radial">辐射状布局</option>
            </select>
        </div>

        <div class="mb-3">
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="show-labels" checked
                       onchange="toggleLabels()">
                <label class="form-check-label small" for="show-labels">显示标签</label>
            </div>
        </div>

        <div class="mb-3">
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="animate-edges" checked
                       onchange="toggleEdgeAnimation()">
                <label class="form-check-label small" for="animate-edges">边线动画</label>
            </div>
        </div>
    </div>

    <!-- 节点详情 -->
    <div class="node-detail" id="node-detail">
        <button type="button" class="btn-close float-end" onclick="hideNodeDetail()"></button>
        <h6 id="node-name" class="mb-3">节点名称</h6>

        <div class="mb-2">
            <small class="text-muted">请求统计</small>
            <div class="d-flex justify-content-between">
                <span>总请求:</span>
                <strong id="node-total">0</strong>
            </div>
            <div class="d-flex justify-content-between">
                <span>成功:</span>
                <strong id="node-success" class="text-success">0</strong>
            </div>
            <div class="d-flex justify-content-between">
                <span>失败:</span>
                <strong id="node-error" class="text-danger">0</strong>
            </div>
        </div>

        <div class="mb-2">
            <small class="text-muted">性能指标</small>
            <div class="d-flex justify-content-between">
                <span>平均耗时:</span>
                <strong id="node-avg-duration">0ms</strong>
            </div>
            <div class="d-flex justify-content-between">
                <span>最大耗时:</span>
                <strong id="node-max-duration">0ms</strong>
            </div>
        </div>

        <div class="mt-3">
            <a href="#" class="btn btn-sm btn-outline-primary w-100" id="node-detail-link">
                <i class="fas fa-search me-1"></i>查看服务详情
            </a>
        </div>
    </div>

    <!-- 拓扑图容器 -->
    <div id="topology-container"></div>

    <!-- 图例 -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h6 class="card-title mb-3"><i class="fas fa-key me-2"></i>图例说明</h6>
                    <div class="row">
                        <div class="col-md-3 mb-2">
                            <div class="d-flex align-items-center">
                                <div class="rounded-circle bg-primary me-2" style="width: 20px; height: 20px;"></div>
                                <small>服务节点</small>
                            </div>
                        </div>
                        <div class="col-md-3 mb-2">
                            <div class="d-flex align-items-center">
                                <div class="border-start border-3 border-success me-2" style="height: 20px;"></div>
                                <small>成功调用</small>
                            </div>
                        </div>
                        <div class="col-md-3 mb-2">
                            <div class="d-flex align-items-center">
                                <div class="border-start border-3 border-danger me-2" style="height: 20px;"></div>
                                <small>失败调用</small>
                            </div>
                        </div>
                        <div class="col-md-3 mb-2">
                            <div class="d-flex align-items-center">
                                <div class="border-start border-3 border-warning me-2" style="height: 20px;"></div>
                                <small>警告调用</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script layout:fragment="scripts">
    let topologyChart = null;
    let topologyData = null;
    let currentNode = null;

    // 初始化拓扑图
    function initTopologyChart() {
        topologyChart = echarts.init(document.getElementById('topology-container'));
        loadTopologyData();

        // 监听点击事件
        topologyChart.on('click', function(params) {
            if (params.dataType === 'node') {
                showNodeDetail(params.data);
            }
        });
    }

    // 加载拓扑数据
    function loadTopologyData() {
        const hours = document.getElementById('time-range').value;

        // 显示加载中
        topologyChart.showLoading({
            text: '加载拓扑数据...',
            color: '#4e73df',
            textColor: '#333',
            maskColor: 'rgba(255, 255, 255, 0.8)'
        });

        fetch(`/insight-ui/api/dependencies?hours=${hours}`)
            .then(response => response.json())
            .then(dependencies => {
                topologyData = dependencies;
                renderTopology(dependencies);
                topologyChart.hideLoading();
            })
            .catch(error => {
                console.error('加载拓扑数据失败:', error);
                topologyChart.hideLoading();
                topologyChart.setOption({
                    title: {
                        text: '加载失败',
                        subtext: error.message,
                        left: 'center',
                        top: 'center'
                    }
                });
            });
    }

    // 渲染拓扑图
    function renderTopology(dependencies) {
        // 收集节点和边
        const nodes = new Map();
        const edges = [];

        dependencies.forEach(dep => {
            const source = dep.source_service;
            const target = dep.target_service;
            const callCount = dep.call_count || 1;
            const avgDuration = dep.avg_duration || 0;
            const errorRate = dep.error_rate || 0;

            // 添加或更新源节点
            if (!nodes.has(source)) {
                nodes.set(source, {
                    name: source,
                    value: 0,
                    symbolSize: 30,
                    itemStyle: {
                        color: getServiceColor(source)
                    },
                    category: 0,
                    label: {
                        show: true
                    },
                    data: {
                        serviceName: source,
                        totalCalls: 0,
                        successCalls: 0,
                        errorCalls: 0,
                        avgDuration: 0,
                        maxDuration: 0,
                        minDuration: 0
                    }
                });
            }

            // 添加或更新目标节点
            if (!nodes.has(target)) {
                nodes.set(target, {
                    name: target,
                    value: 0,
                    symbolSize: 30,
                    itemStyle: {
                        color: getServiceColor(target)
                    },
                    category: 0,
                    label: {
                        show: true
                    },
                    data: {
                        serviceName: target,
                        totalCalls: 0,
                        successCalls: 0,
                        errorCalls: 0,
                        avgDuration: 0,
                        maxDuration: 0,
                        minDuration: 0
                    }
                });
            }

            // 更新节点统计
            const sourceNode = nodes.get(source);
            sourceNode.data.totalCalls += callCount;
            sourceNode.value += callCount;

            const targetNode = nodes.get(target);
            targetNode.data.totalCalls += callCount;
            targetNode.value += callCount;

            // 添加边
            edges.push({
                source: source,
                target: target,
                value: callCount,
                lineStyle: {
                    width: Math.min(8, Math.log(callCount + 1) * 2),
                    curveness: 0.2,
                    color: errorRate > 10 ? '#e74a3b' : errorRate > 5 ? '#f6c23e' : '#1cc88a'
                },
                label: {
                    show: true,
                    formatter: `${callCount}次\n${avgDuration.toFixed(0)}ms`
                }
            });
        });

        // 计算节点大小
        const nodeValues = Array.from(nodes.values()).map(n => n.value);
        const maxValue = Math.max(...nodeValues);
        const minValue = Math.min(...nodeValues);

        nodes.forEach(node => {
            const sizeType = document.getElementById('node-size').value;
            if (sizeType === 'traffic') {
                node.symbolSize = 20 + (node.value / maxValue) * 50;
            } else if (sizeType === 'fixed') {
                node.symbolSize = 40;
            }
        });

        const option = {
            tooltip: {
                formatter: function(params) {
                    if (params.dataType === 'node') {
                        return `
                            <div style="font-weight: bold; margin-bottom: 5px;">
                                ${params.data.name}
                            </div>
                            <div>总调用: ${params.data.data.totalCalls}</div>
                            <div>平均耗时: ${params.data.data.avgDuration}ms</div>
                        `;
                    } else if (params.dataType === 'edge') {
                        return `
                            <div style="font-weight: bold; margin-bottom: 5px;">
                                ${params.data.source} → ${params.data.target}
                            </div>
                            <div>调用次数: ${params.data.value}</div>
                        `;
                    }
                }
            },
            animationDurationUpdate: 1500,
            animationEasingUpdate: 'quinticInOut',
            series: [
                {
                    type: 'graph',
                    layout: document.getElementById('layout-type').value,
                    data: Array.from(nodes.values()),
                    links: edges,
                    roam: true,
                    label: {
                        show: document.getElementById('show-labels').checked,
                        position: 'right',
                        formatter: '{b}',
                        fontSize: 12
                    },
                    lineStyle: {
                        color: 'source',
                        curveness: 0.3,
                        opacity: 0.8
                    },
                    emphasis: {
                        focus: 'adjacency',
                        lineStyle: {
                            width: 10
                        }
                    },
                    edgeSymbol: ['circle', 'arrow'],
                    edgeSymbolSize: [4, 10],
                    edgeLabel: {
                        show: true,
                        fontSize: 10
                    },
                    force: {
                        repulsion: 2000,
                        edgeLength: 150,
                        layoutAnimation: document.getElementById('animate-edges').checked
                    }
                }
            ]
        };

        topologyChart.setOption(option);
    }

    // 显示节点详情
    function showNodeDetail(nodeData) {
        currentNode = nodeData;

        // 更新详情面板
        document.getElementById('node-name').textContent = nodeData.name;
        document.getElementById('node-total').textContent = nodeData.data.totalCalls || 0;
        document.getElementById('node-avg-duration').textContent =
            `${nodeData.data.avgDuration || 0}ms`;
        document.getElementById('node-max-duration').textContent =
            `${nodeData.data.maxDuration || 0}ms`;

        // 计算成功和失败调用数（简化处理）
        const successRate = nodeData.data.successCalls ?
            (nodeData.data.successCalls / nodeData.data.totalCalls) : 0.95;
        document.getElementById('node-success').textContent =
            Math.round(nodeData.data.totalCalls * successRate);
        document.getElementById('node-error').textContent =
            Math.round(nodeData.data.totalCalls * (1 - successRate));

        // 设置详情链接
        document.getElementById('node-detail-link').href =
            `/insight-ui/service?name=${encodeURIComponent(nodeData.name)}`;

        // 显示详情面板
        document.getElementById('node-detail').style.display = 'block';
    }

    // 隐藏节点详情
    function hideNodeDetail() {
        document.getElementById('node-detail').style.display = 'none';
        currentNode = null;
    }

    // 更新节点大小
    function updateNodeSize() {
        if (topologyData) {
            renderTopology(topologyData);
        }
    }

    // 切换布局类型
    function changeLayout() {
        if (topologyData) {
            renderTopology(topologyData);
        }
    }

    // 切换标签显示
    function toggleLabels() {
        const showLabels = document.getElementById('show-labels').checked;
        topologyChart.setOption({
            series: [{
                label: { show: showLabels }
            }]
        });
    }

    // 切换边线动画
    function toggleEdgeAnimation() {
        if (topologyData) {
            renderTopology(topologyData);
        }
    }

    // 自动布局
    function autoLayout() {
        topologyChart.setOption({
            series: [{
                force: {
                    repulsion: 2000,
                    edgeLength: 150
                }
            }]
        });
    }

    // 导出拓扑图
    function exportTopology() {
        const imageUrl = topologyChart.getDataURL({
            type: 'png',
            pixelRatio: 2,
            backgroundColor: '#fff'
        });

        const link = document.createElement('a');
        link.href = imageUrl;
        link.download = `topology-${new Date().toISOString().slice(0, 10)}.png`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        showToast('拓扑图已导出为PNG图片', 'success');
    }

    // 页面初始化
    document.addEventListener('DOMContentLoaded', function() {
        initTopologyChart();

        // 监听窗口大小变化
        window.addEventListener('resize', function() {
            if (topologyChart) {
                topologyChart.resize();
            }
        });
    });

    // 全局刷新函数
    window.refreshDashboard = function() {
        loadTopologyData();
    };
</script>

</body>
</html>